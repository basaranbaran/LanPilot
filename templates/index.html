<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LanPilot Remote</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body {
            width: 100vw; height: 100vh;
            overflow: hidden;
            background-color: #000;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            user-select: none; -webkit-user-select: none;
        }
        #stream-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; z-index: 1;
        }
        #screen { width: 100%; height: 100%; object-fit: contain; cursor: crosshair; }
        #menu-toggle-btn {
            position: absolute; top: 80px; right: 20px;
            width: 55px; height: 55px;
            background: rgba(30, 30, 30, 0.7); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: grab; z-index: 1001;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: transform 0.1s;
        }
        #menu-toggle-btn.dragging { cursor: grabbing; transform: scale(1.1); }
        #ui-layer {
            position: absolute; bottom: 20px;
            width: 100%; display: flex; justify-content: center;
            flex-wrap: wrap; gap: 10px; z-index: 999;
            transition: opacity 0.3s, transform 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; transform: translateY(20px); }
        .btn {
            background: rgba(30, 30, 30, 0.7); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1); color: white;
            padding: 12px 18px; border-radius: 12px; font-size: 16px;
            font-weight: 500; cursor: pointer;
        }
        .btn:active { transform: scale(0.95); }
        .blue { background-color: rgba(13, 110, 253, 0.6); }
        .green { background-color: rgba(40, 167, 69, 0.6); }
        .red { background-color: rgba(220, 53, 69, 0.6); }
    </style>
</head>
<body>
    <div id="stream-wrapper">
        <img id="screen" src="{{ url_for('video_feed') }}">
    </div>
    <div id="menu-toggle-btn">☰</div>
    <div id="ui-layer" class="hidden">
        <button class="btn blue" ontouchstart="triggerAltTab(); event.preventDefault()" onclick="triggerAltTab()">Alt-Tab</button>
        <button class="btn" ontouchstart="sendText(); event.preventDefault()" onclick="sendText()">⌨️ Yaz</button>
        <button class="btn green" ontouchstart="sendKey('enter'); event.preventDefault()" onclick="sendKey('enter')">↵ Enter</button>
        <button class="btn red" ontouchstart="sendKey('backspace'); event.preventDefault()" onclick="sendKey('backspace')">⌫ Sil</button>
    </div>

    <script>
        const img = document.getElementById('screen');
        const uiLayer = document.getElementById('ui-layer');
        const menuBtn = document.getElementById('menu-toggle-btn');

        // --- DÜZELTME 2: NOKTA ATIŞI TIKLAMA MANTIĞI ---
        img.addEventListener('click', (e) => {
            // Python'dan gelen PC ekran oranını alıyoruz
            const pcScreenRatio = {{ pc_screen_width }} / {{ pc_screen_height }};

            // Telefondaki <img> elementinin boyutlarını ve oranını alıyoruz
            const rect = img.getBoundingClientRect();
            const containerRatio = rect.width / rect.height;

            let renderedWidth, renderedHeight, offsetX, offsetY;

            // Siyah boşlukların (letterbox) nerede olduğunu ve boyutunu hesaplıyoruz
            if (containerRatio > pcScreenRatio) { // Boşluklar sağda ve solda
                renderedHeight = rect.height;
                renderedWidth = renderedHeight * pcScreenRatio;
                offsetX = (rect.width - renderedWidth) / 2;
                offsetY = 0;
            } else { // Boşluklar altta ve üstte
                renderedWidth = rect.width;
                renderedHeight = renderedWidth / pcScreenRatio;
                offsetX = 0;
                offsetY = (rect.height - renderedHeight) / 2;
            }

            // Tıklanan yerden siyah boşlukları çıkararak sadece resim üzerindeki koordinatı buluyoruz
            const xOnImage = e.clientX - rect.left - offsetX;
            const yOnImage = e.clientY - rect.top - offsetY;

            // Eğer tıklama siyah boşluklara geldiyse, işlemi iptal ediyoruz
            if (xOnImage < 0 || xOnImage > renderedWidth || yOnImage < 0 || yOnImage > renderedHeight) {
                return;
            }

            // Son ve %100 doğru oranları hesaplayıp sunucuya gönderiyoruz
            const finalRelX = xOnImage / renderedWidth;
            const finalRelY = yOnImage / renderedHeight;

            postData('/click', { x: finalRelX, y: finalRelY });
        });

        // --- SÜRÜKLENEBİLİR BUTON MANTIĞI (DEĞİŞİKLİK YOK) ---
        let isDragging = false, hasMoved = false, offsetXBtn, offsetYBtn;
        function dragStart(e) {
            isDragging = true; hasMoved = false;
            menuBtn.classList.add('dragging');
            const rect = menuBtn.getBoundingClientRect();
            const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
            offsetXBtn = clientX - rect.left;
            offsetYBtn = clientY - rect.top;
        }
        function dragMove(e) {
            if (!isDragging) return;
            e.preventDefault(); hasMoved = true;
            const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
            let newX = clientX - offsetXBtn;
            let newY = clientY - offsetYBtn;
            newX = Math.max(0, Math.min(newX, window.innerWidth - menuBtn.offsetWidth));
            newY = Math.max(0, Math.min(newY, window.innerHeight - menuBtn.offsetHeight));
            menuBtn.style.left = `${newX}px`;
            menuBtn.style.top = `${newY}px`;
            menuBtn.style.right = 'auto';
        }
        function dragEnd() {
            if (!isDragging) return;
            isDragging = false;
            menuBtn.classList.remove('dragging');
            if (!hasMoved) { uiLayer.classList.toggle('hidden'); }
        }
        menuBtn.addEventListener('mousedown', dragStart);
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
        menuBtn.addEventListener('touchstart', dragStart, { passive: false });
        document.addEventListener('touchmove', dragMove, { passive: false });
        document.addEventListener('touchend', dragEnd);

        // --- DİĞER FONKSİYONLAR (DEĞİŞİKLİK YOK) ---
        function triggerAltTab() { postData('/alttab', {}); }
        function sendText() { let text = prompt("Yazılacak metin:"); if (text) postData('/type', { text: text }); }
        function sendKey(key) { postData('/key', { key: key }); }
        function postData(url, data) {
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).catch(error => console.error('Hata:', error));
        }
    </script>
</body>
</html>